<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build a CW20 tokens factory &mdash; Terra Classic Docs  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/docs_favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="../../../../_static/design-tabs.js"></script>
        <script src="../../../../_static/custom.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="In-depth dApp guide" href="../smart-contracts/README.html" />
    <link rel="prev" title="Migrating CosmWasm contracts on Terra" href="contract-migration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html">
            <img src="../../../../_static/docs_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../learn/README.html">Learn</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Develop</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../full-node/README.html">Full node</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ecosystem/README.html">Ecosystem</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../spacecamp/README.html">Hackathon resources </a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../learn/terra-station/README.html">Terra Station</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="README.html">Terrain Quickstart</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="README.html#contents">Contents </a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="initial-setup.html">Terrain initial setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="using-terrain-testnet.html">Use Terrain with the testnet</a></li>
<li class="toctree-l4"><a class="reference internal" href="using-terrain-testnet.html#counter-tutorial">Counter tutorial</a></li>
<li class="toctree-l4"><a class="reference internal" href="using-terrain-localterra.html">Use Terrain with LocalTerra</a></li>
<li class="toctree-l4"><a class="reference internal" href="using-terrain-localterra.html#counter-tutorial">Counter tutorial</a></li>
<li class="toctree-l4"><a class="reference internal" href="mint-an-nft.html">Mint an NFT using Terrain</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-migration.html">Migrating CosmWasm contracts on Terra</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Build a CW20 tokens factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#instantiate-a-new-app-using-terrain">1. Instantiate a new app using Terrain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#instantiate-the-token-factory-and-cw20-factory-token-contracts">2. Instantiate the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> and <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contracts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-the-mnemonics-passphrase">3. Modify the mnemonics passphrase</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-the-smart-contracts">4. Deploy the smart contracts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-the-cw20-factory-token-smart-contract">5. Modify the CW20 Factory Token smart contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-the-token-factory-smart-contract">3. Create the Token Factory smart contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-the-smart-contract-to-localterra">7. Deploy the smart contract to LocalTerra</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="using-terrain-localterra.html">Use Terrain with LocalTerra</a></li>
<li class="toctree-l2"><a class="reference internal" href="using-terrain-localterra.html#counter-tutorial">Counter tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="using-terrain-testnet.html">Use Terrain with the testnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="using-terrain-testnet.html#counter-tutorial">Counter tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../smart-contracts/README.html">In-depth dApp guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../endpoints.html">RPC and LCD endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../module-specifications/README.html">Terra Core modules </a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdks/terra-js/README.html">Terra.js </a></li>
<li class="toctree-l2"><a class="reference external" href="https://terra-money.github.io/terra.py/">Terra.py</a></li>
<li class="toctree-l2"><a class="reference external" href="https://faucet.terra.money/">Faucet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ecosystem/integrations.html">Block explorers</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Terra Classic Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../README.html">Develop</a></li>
          <li class="breadcrumb-item"><a href="../README.html">Build a dApp</a></li>
          <li class="breadcrumb-item"><a href="README.html">Terrain quickstart guide</a></li>
      <li class="breadcrumb-item active">Build a CW20 tokens factory</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/docs/develop/dapp/quick-start/cw20-factory.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="tex2jax_ignore mathjax_ignore section" id="build-a-cw20-tokens-factory">
<h1>Build a CW20 tokens factory<a class="headerlink" href="#build-a-cw20-tokens-factory" title="Permalink to this headline"></a></h1>
<p>In this tutorial, you’ll build a CW20 token factory. A token factory allows any ​CosmosSDK address — including a contract — to mint new fungible tokens based. To accomplish this you’ll do the following:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#prerequisites"><span class="std std-doc">0. Complete the prerequisites</span></a></p></li>
<li><p><a class="reference internal" href="#instantiate-a-new-app-using-terrain"><span class="std std-doc">1. Instantiate a new app using Terrain</span></a></p></li>
<li><p><span class="xref myst">2. Instantiate the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> and <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contracts</span></p></li>
<li><p><a class="reference internal" href="#modify-the-mnemonics-passphrase"><span class="std std-doc">3. Modify the mnemonics passphrase</span></a></p></li>
<li><p><a class="reference internal" href="#deploy-the-smart-contracts"><span class="std std-doc">4. Deploy the smart contracts</span></a></p></li>
<li><p><a class="reference internal" href="#modify-the-cw20-factory-token-smart-contract"><span class="std std-doc">5. Modify the CW20 Factory Token smart contract</span></a></p>
<ul>
<li><p><a class="reference internal" href="#add-the-the-cw20-base"><span class="std std-doc">1. Add the the CW20 base</span></a></p></li>
<li><p><a class="reference internal" href="#modify-the-contract-files"><span class="std std-doc">2. Modify the contract files</span></a></p></li>
<li><p><a class="reference internal" href="#generate-and-test-the-schema"><span class="std std-doc">3. Generate and test the schema</span></a></p></li>
<li><p><span class="xref myst">4. Modify <code class="docutils literal notranslate"><span class="pre">terrain.config.json</span></code></span></p></li>
<li><p><span class="xref myst">5. Test the smart contract deployment</span></p></li>
<li><p><span class="xref myst">6. Use crate.io to implement the CW20 Token Factory as a dependency</span></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#create-the-token-factory-smart-contract"><span class="std std-doc">6. Modify the Token Factory smart contract</span></a></p>
<ul>
<li><p><a class="reference internal" href="#add-the-dependencies"><span class="std std-doc">1. Add the dependencies</span></a></p></li>
<li><p><a class="reference internal" href="#id1"><span class="std std-doc">2. Modify the contract files</span></a></p></li>
<li><p><a class="reference internal" href="#id2"><span class="std std-doc">3. Generate and test the schema</span></a></p></li>
<li><p><a class="reference internal" href="#modify-terrain-config-json"><span class="std std-doc">4. Modify terrain.config.json</span></a></p></li>
</ul>
</li>
<li><p><span class="xref myst">7. Deploy the smart contract to LocalTerra</span></p></li>
</ul>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h2>
<p>First, set up your environment:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.terra.money/docs/develop/dapp/quick-start/initial-setup.html#initial-setup">A Terrain development environment</a></p></li>
<li><p><a class="reference external" href="https://docs.terra.money/docs/develop/dapp/quick-start/using-terrain-localterra.html#install-and-run-localterra">A LocalTerra node</a></p></li>
<li><p><a class="reference external" href="https://docs.terra.money/docs/learn/terra-station/download/terra-station-extension.html">The Terra Station Extension wallet to interact with the smart contract</a></p></li>
<li><p>An IDE or text editor of your choice. For the purpose of this tutorial, Visual Studio Code will be used.</p></li>
<li><p>A command line interface</p></li>
</ul>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="instantiate-a-new-app-using-terrain">
<h1>1. Instantiate a new app using Terrain<a class="headerlink" href="#instantiate-a-new-app-using-terrain" title="Permalink to this headline"></a></h1>
<p>a. Instantiate a new app using Terrain:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>terrain new token-factory
</pre></div>
</div>
<p>When the app is generated, the following displays:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>generating:
- contract... <span class="k">done</span>
- frontend... <span class="k">done</span>
</pre></div>
</div>
<p>b. Navigate to the <code class="docutils literal notranslate"><span class="pre">contracts</span></code> folder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">contracts</span><span class="o">/</span>
</pre></div>
</div>
<p>c. Terrain automatically generates a sample <code class="docutils literal notranslate"><span class="pre">counter</span></code> contract in the <code class="docutils literal notranslate"><span class="pre">contracts</span></code> folder. Delete the <code class="docutils literal notranslate"><span class="pre">counter</span></code> smart contract folder to ensure a clean workspace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="n">counter</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="instantiate-the-token-factory-and-cw20-factory-token-contracts">
<h1>2. Instantiate the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> and <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contracts<a class="headerlink" href="#instantiate-the-token-factory-and-cw20-factory-token-contracts" title="Permalink to this headline"></a></h1>
<p>a. Navigate to the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> directory:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> token-factory
</pre></div>
</div>
<p>b. Instantiate the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> contract:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>terrain code:new token-factory
</pre></div>
</div>
<p>When the contract is generated, the following displays:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>generating contract... <span class="k">done</span>
</pre></div>
</div>
<p>c. Instantiate the <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contract:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">terrain</span> <span class="n">code</span><span class="p">:</span><span class="n">new</span> <span class="n">cw20</span><span class="o">-</span><span class="n">factory</span><span class="o">-</span><span class="n">token</span>
</pre></div>
</div>
<p>When the contract is generated, the following displays:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>generating contract... <span class="k">done</span>
</pre></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="modify-the-mnemonics-passphrase">
<h1>3. Modify the mnemonics passphrase<a class="headerlink" href="#modify-the-mnemonics-passphrase" title="Permalink to this headline"></a></h1>
<p>Before editing the smart contracts you instantiated in step 2, modify the mnemonic you’ll use to do deploy the contract to LocalTerra:</p>
<p>a. Navigate to <code class="docutils literal notranslate"> <span class="pre">/token-factory</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">token</span><span class="o">-</span><span class="n">factory</span>
</pre></div>
</div>
<p>b. Open <code class="docutils literal notranslate"><span class="pre">/keys.terrain.js</span></code> and set the <code class="docutils literal notranslate"><span class="pre">mnemonic</span></code>s to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">notice</span> <span class="n">oak</span> <span class="n">worry</span> <span class="n">limit</span> <span class="n">wrap</span> <span class="n">speak</span> <span class="n">medal</span> <span class="n">online</span> <span class="n">prefer</span> <span class="n">cluster</span> <span class="n">roof</span> <span class="n">addict</span> <span class="n">wrist</span> <span class="n">behave</span> <span class="n">treat</span> <span class="n">actual</span> <span class="n">wasp</span> <span class="n">year</span> <span class="n">salad</span> <span class="n">speed</span> <span class="n">social</span> <span class="n">layer</span> <span class="n">crew</span> <span class="n">genius</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Because the wallet contains funds, it is recommended that you also import the passphrase listed below into the Terra Station Extension. You can view other example mnemonics [on Github] (<a class="reference external" href="https://github.com/terra-money/LocalTerra/blob/main/terracore/mnemonics.json#L9">https://github.com/terra-money/LocalTerra/blob/main/terracore/mnemonics.json#L9</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">notice</span> <span class="n">oak</span> <span class="n">worry</span> <span class="n">limit</span> <span class="n">wrap</span> <span class="n">speak</span> <span class="n">medal</span> <span class="n">online</span> <span class="n">prefer</span> <span class="n">cluster</span> <span class="n">roof</span> <span class="n">addict</span> <span class="n">wrist</span> <span class="n">behave</span> <span class="n">treat</span> <span class="n">actual</span> <span class="n">wasp</span> <span class="n">year</span> <span class="n">salad</span> <span class="n">speed</span> <span class="n">social</span> <span class="n">layer</span> <span class="n">crew</span> <span class="n">genius</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">module.exports</span></code> section of your <code class="docutils literal notranslate"><span class="pre">keys.terrain.js</span></code> file should now look similar to the following:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">mnemonic</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;notice oak worry limit wrap speak medal online prefer cluster roof addict wrist behave treat actual wasp year salad speed social layer crew genius&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="deploy-the-smart-contracts">
<h1>4. Deploy the smart contracts<a class="headerlink" href="#deploy-the-smart-contracts" title="Permalink to this headline"></a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> contract mints new <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> tokens, increases the supply of minted tokens, burns tokens to return UST and tracks all tokens created.</p>
<p>Deploy each smart contract to validate that the development environment is configured correctly:</p>
<p>a. Deploy the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> contract:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">terrain</span> <span class="n">deploy</span> <span class="n">token</span><span class="o">-</span><span class="n">factory</span> <span class="o">--</span><span class="n">signer</span> <span class="n">test</span>
</pre></div>
</div>
<p>b. Deploy the <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contract:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">terrain</span> <span class="n">deploy</span> <span class="n">cw20</span><span class="o">-</span><span class="n">factory</span><span class="o">-</span><span class="n">token</span> <span class="o">--</span><span class="n">signer</span> <span class="n">test</span>
</pre></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="modify-the-cw20-factory-token-smart-contract">
<h1>5. Modify the CW20 Factory Token smart contract<a class="headerlink" href="#modify-the-cw20-factory-token-smart-contract" title="Permalink to this headline"></a></h1>
<p>In this section, you will modify the <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contract that you instantiated. This contract implements the <a class="reference external" href="https://github.com/CosmWasm/cw-plus/tree/0.9.x/contracts/cw20-base">CW20 Base</a>, along with several custom files.</p>
<p>To modify the <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contract, follow the procedure below.</p>
<div class="section" id="add-the-the-cw20-base">
<h2>1. Add the the CW20 base<a class="headerlink" href="#add-the-the-cw20-base" title="Permalink to this headline"></a></h2>
<p>First, add the <a class="reference external" href="https://github.com/CosmWasm/cw-plus/tree/main/contracts/cw20-base">CW20 Base</a>, which implements the base CW20 token functionalities. This allows:</p>
<ul class="simple">
<li><p>the smart contract to be easily deployed to LocalTerra</p></li>
<li><p>extended functionality using the <a class="reference external" href="https://docs.terra.money/docs/develop/dapp/quick-start/contract-migration.html">migration implementation</a>.</p></li>
</ul>
<p>To add the CW20 Base to the <code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code> contract, do the following:</p>
<p>a. Navigate to <code class="docutils literal notranslate"><span class="pre">/token-factory/contracts/cw20-factory-token/</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">token</span><span class="o">-</span><span class="n">factory</span><span class="o">/</span><span class="n">contracts</span><span class="o">/</span><span class="n">cw20</span><span class="o">-</span><span class="n">factory</span><span class="o">-</span><span class="n">token</span><span class="o">/</span>
</pre></div>
</div>
<p>b. Open <code class="docutils literal notranslate"><span class="pre">cargo.toml</span></code> and add this to the dependencies:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span>#<span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="n">cw20</span><span class="o">-</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.8.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;library&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

#<span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="modify-the-contract-files">
<h2>2. Modify the contract files<a class="headerlink" href="#modify-the-contract-files" title="Permalink to this headline"></a></h2>
<p>Now that you’ve added the <code class="docutils literal notranslate"><span class="pre">CW20</span> <span class="pre">Base</span></code> to implement the base CW20 token logic, modify the following files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">msg.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lib.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contract.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">schemas.rs</span></code></p></li>
</ul>
<p>To modify the contract files, follow the procedure below.</p>
<p>a. Navigate to <code class="docutils literal notranslate"><span class="pre">/token-factory/contracts/cw20-factory-token/src</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">token</span><span class="o">-</span><span class="n">factory</span><span class="o">/</span><span class="n">contracts</span><span class="o">/</span><span class="n">cw20</span><span class="o">-</span><span class="n">factory</span><span class="o">-</span><span class="n">token</span><span class="o">/</span><span class="n">src</span>
</pre></div>
</div>
<p>b. Open <code class="docutils literal notranslate"><span class="pre">msg.rs</span></code> and paste the following:</p>
<div class="highlight-Rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">schemars</span>::<span class="n">JsonSchema</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MigrateMsg</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>c. Save and close <code class="docutils literal notranslate"><span class="pre">msg.rs</span></code>.</p>
<p>d. Open <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code> and paste the following:</p>
<div class="highlight-Rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">contract</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">msg</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>e. Save and close <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code>.</p>
<p>f. Open <code class="docutils literal notranslate"><span class="pre">contract.rs</span></code> and paste the following:</p>
<div class="highlight-Rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[cfg(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">))]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="n">entry_point</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">to_binary</span><span class="p">,</span><span class="w"> </span><span class="n">Binary</span><span class="p">,</span><span class="w"> </span><span class="n">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">Env</span><span class="p">,</span><span class="w"> </span><span class="n">MessageInfo</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdResult</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">ContractError</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">enumerable</span>::<span class="p">{</span><span class="n">query_all_allowances</span><span class="p">,</span><span class="w"> </span><span class="n">query_all_accounts</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="p">{</span><span class="n">QueryMsg</span><span class="p">,</span><span class="n">ExecuteMsg</span><span class="p">};</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">msg</span>::<span class="n">MigrateMsg</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw2</span>::<span class="n">set_contract_version</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">allowances</span>::<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">execute_decrease_allowance</span><span class="p">,</span><span class="w"> </span><span class="n">execute_increase_allowance</span><span class="p">,</span><span class="w"> </span><span class="n">execute_send_from</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">execute_transfer_from</span><span class="p">,</span><span class="w"> </span><span class="n">query_allowance</span><span class="p">,</span><span class="w"> </span><span class="n">execute_burn_from</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">contract</span>::<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">execute_mint</span><span class="p">,</span><span class="w"> </span><span class="n">execute_send</span><span class="p">,</span><span class="w"> </span><span class="n">execute_transfer</span><span class="p">,</span><span class="w"> </span><span class="n">execute_update_marketing</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">execute_upload_logo</span><span class="p">,</span><span class="w"> </span><span class="n">query_balance</span><span class="p">,</span><span class="w"> </span><span class="n">query_token_info</span><span class="p">,</span><span class="w"> </span><span class="n">query_minter</span><span class="p">,</span><span class="w"> </span><span class="n">query_download_logo</span><span class="p">,</span><span class="w"> </span><span class="n">query_marketing_info</span><span class="p">,</span><span class="w"> </span><span class="n">execute_burn</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">// version info for migration info</span>
<span class="k">const</span><span class="w"> </span><span class="n">CONTRACT_NAME</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;crates.io:cw20-factory-token&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">CONTRACT_VERSION</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="fm">env!</span><span class="p">(</span><span class="s">&quot;CARGO_PKG_VERSION&quot;</span><span class="p">);</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">instantiate</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">msg</span>: <span class="nc">cw20_base</span>::<span class="n">msg</span>::<span class="n">InstantiateMsg</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">set_contract_version</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">CONTRACT_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">CONTRACT_VERSION</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Execute the instantiate method from cw_20_base as the code from that</span>
<span class="cm">    library is already battle tested we do not have to re-write the full</span>
<span class="cm">    functionality: https://github.com/CosmWasm/cw-plus/tree/main/contracts/cw20-base*/</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">cw20_base</span>::<span class="n">contract</span>::<span class="n">instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">msg</span>: <span class="nc">ExecuteMsg</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">Transfer</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">recipient</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">execute_transfer</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">recipient</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">Burn</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_burn</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="nb">Send</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_send</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">contract</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">Mint</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">recipient</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_mint</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">recipient</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">IncreaseAllowance</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">spender</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">expires</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_increase_allowance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">spender</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">expires</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">DecreaseAllowance</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">spender</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">expires</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_decrease_allowance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">spender</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">expires</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">TransferFrom</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">recipient</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_transfer_from</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">recipient</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">BurnFrom</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_burn_from</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">SendFrom</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">contract</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_send_from</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">contract</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">UpdateMarketing</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">project</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">description</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">marketing</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_update_marketing</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">marketing</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">UploadLogo</span><span class="p">(</span><span class="n">logo</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_upload_logo</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">logo</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">QueryMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Default methods from CW20 Standard with no modifications:</span>
<span class="cm">        https://github.com/CosmWasm/cw-plus/tree/main/contracts/cw20-base */</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">Balance</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_balance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">TokenInfo</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_token_info</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">Minter</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_minter</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">Allowance</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">spender</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_allowance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">spender</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">AllAllowances</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">owner</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">start_after</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">limit</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_all_allowances</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">start_after</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">AllAccounts</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">start_after</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_all_accounts</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">start_after</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">MarketingInfo</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_marketing_info</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">DownloadLogo</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_download_logo</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">migrate</span><span class="p">(</span><span class="n">_deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">_msg</span>: <span class="nc">MigrateMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">default</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>g. Save and close <code class="docutils literal notranslate"><span class="pre">contract.rs</span></code>.</p>
<p>h. Open <code class="docutils literal notranslate"><span class="pre">schemas.rs</span></code> and paste the following:</p>
<div class="highlight-Rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">current_dir</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">create_dir_all</span><span class="p">;</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_schema</span>::<span class="p">{</span><span class="n">export_schema</span><span class="p">,</span><span class="w"> </span><span class="n">remove_schemas</span><span class="p">,</span><span class="w"> </span><span class="n">schema_for</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="p">{</span><span class="n">InstantiateMsg</span><span class="p">,</span><span class="w"> </span><span class="n">QueryMsg</span><span class="p">,</span><span class="w"> </span><span class="n">ExecuteMsg</span><span class="p">};</span><span class="w"></span>


<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">out_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_dir</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">out_dir</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="s">&quot;schema&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">create_dir_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">remove_schemas</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">export_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema_for</span><span class="o">!</span><span class="p">(</span><span class="n">InstantiateMsg</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">export_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema_for</span><span class="o">!</span><span class="p">(</span><span class="n">ExecuteMsg</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">export_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema_for</span><span class="o">!</span><span class="p">(</span><span class="n">QueryMsg</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>i. Close and save <code class="docutils literal notranslate"><span class="pre">schemas.rs</span></code>:</p>
</div>
<div class="section" id="generate-and-test-the-schema">
<h2>3. Generate and test the schema<a class="headerlink" href="#generate-and-test-the-schema" title="Permalink to this headline"></a></h2>
<p>a. Navigate to <code class="docutils literal notranslate"><span class="pre">/token-factory/contracts/cw20-factory-token</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">token</span><span class="o">-</span><span class="n">factory</span><span class="o">/</span><span class="n">contracts</span><span class="o">/</span><span class="n">cw20</span><span class="o">-</span><span class="n">factory</span><span class="o">-</span><span class="n">token</span>
</pre></div>
</div>
<p>b. Generate the new schema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span> <span class="n">schema</span>
</pre></div>
</div>
<p>c. Test the schema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cargo</span> <span class="n">test</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-terrain-config-json">
<h2>4. Modify <code class="docutils literal notranslate"><span class="pre">terrain.config.json</span></code><a class="headerlink" href="#modify-terrain-config-json" title="Permalink to this headline"></a></h2>
<p>a. Open <code class="docutils literal notranslate"><span class="pre">terrain.config.json</span></code>.</p>
<p>b. Modify the <code class="docutils literal notranslate"><span class="pre">InstantiateMsg</span></code> property in the <code class="docutils literal notranslate"><span class="pre">terrain.config.json</span></code> so that it contains the <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">symbol</span></code>, <code class="docutils literal notranslate"><span class="pre">decimals</span></code> and <code class="docutils literal notranslate"><span class="pre">initial_balances</span></code> shown below. This allows you to send the correct data to the smart contract upon instantiation:</p>
<div class="highlight-Json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;_global&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;_base&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;instantiation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;instantiateMsg&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bit Money&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;symbol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BTM&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;decimals&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nt">&quot;initial_balances&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="nt">&quot;address&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;terra1x46rqay4d3cssq8gxxvqz8xt6nwlz4td20k38v&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="test-the-smart-contract-deployment">
<h2>5. Test the smart contract deployment<a class="headerlink" href="#test-the-smart-contract-deployment" title="Permalink to this headline"></a></h2>
<p>Deploy the contract again to confirm that the workplace still compiles.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>terrain deploy cw20-factory-token --signer <span class="nb">test</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If your code is not working as expected, you can <a class="reference external" href="https://github.com/emidev98/token-factory/commit/fdba3c89c464860fe8cd9aa17f1344d82d613522">clone the repo with all the changes described above</a> so that you can continue with the tutorial. To clone the repo, do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="o">-</span><span class="n">n</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">emidev98</span><span class="o">/</span><span class="n">token</span><span class="o">-</span><span class="n">factory</span>
<span class="n">cd</span> <span class="n">token</span><span class="o">-</span><span class="n">factory</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">fdba3c89c464860fe8cd9aa17f1344d82d613522</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="use-crate-io-to-implement-the-cw20-token-factory-as-a-dependency">
<h2>6. Use <a class="reference external" href="http://crate.io">crate.io</a> to implement the CW20 Token Factory as a dependency<a class="headerlink" href="#use-crate-io-to-implement-the-cw20-token-factory-as-a-dependency" title="Permalink to this headline"></a></h2>
<p>For the purpose of this tutorial, <a class="reference external" href="https:%5Ccrates.io">crates.io</a> is used to implement the CW20 Token Factory as a dependency. This ensures that CW20 Token Factory is platform agnostic, so you can use Linux, Windows or Mac.</p>
<p>As the deployment to <a class="reference external" href="http://crates.io">crates.io</a> is out of scope for this tutorial, you can find <a class="reference external" href="https://crates.io/crates/cw20-factory-token">the CW20 Token Factory package deployed to crates.io</a>. You can use this deployment when you add the CW20 Token Factory contract as a dependency of the Token Factory contract in the the next section.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="create-the-token-factory-smart-contract">
<h1>3. Create the Token Factory smart contract<a class="headerlink" href="#create-the-token-factory-smart-contract" title="Permalink to this headline"></a></h1>
<p>To set up the contract, follow the procedure below:</p>
<div class="section" id="add-the-dependencies">
<h2>1. Add the dependencies<a class="headerlink" href="#add-the-dependencies" title="Permalink to this headline"></a></h2>
<p>In this section, you will add the following dependencies to <code class="docutils literal notranslate"><span class="pre">cargo.toml</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cw2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cw20</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cw20-base</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cw20-factory-token</span></code></p></li>
</ul>
<p>To add the dependencies, do the following:</p>
<p>a. Navigate to <code class="docutils literal notranslate"><span class="pre">/token-factory/contracts/token-factory</span></code>.</p>
<p>b. Open <code class="docutils literal notranslate"><span class="pre">cargo.toml</span></code> and add the dependencies inside the header:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span>#<span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="n">cw2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.8.1&quot;</span><span class="w"></span>
<span class="n">cw20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.8.1&quot;</span><span class="w"></span>
<span class="n">cw20</span><span class="o">-</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.8.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;library&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">cw20</span><span class="o">-</span><span class="n">factory</span><span class="o">-</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.5.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;library&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

#<span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>2. Modify the contract files<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<p>Now that you’ve added the dependencies, modify the following files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">error.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">msg.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lib.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">state.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contract.rs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test.rs</span></code></p></li>
</ul>
<p>To modify the contract files, follow the procedure below:</p>
<p>a. Navigate to <code class="docutils literal notranslate"><span class="pre">/token-factory/contracts/token-factory/src</span></code>.</p>
<p>b. Open <code class="docutils literal notranslate"><span class="pre">error.rs</span></code> and add the following:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="n">StdError</span><span class="p">,</span><span class="w"> </span><span class="n">Uint128</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">thiserror</span>::<span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Error, Debug, PartialEq)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ContractError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;{0}&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">Std</span><span class="p">(</span><span class="cp">#[from]</span><span class="w"> </span><span class="n">StdError</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Unauthorized&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">Unauthorized</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;NotReceivedFunds&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">NotReceivedFunds</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;NotAllowZeroAmount&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">NotAllowZeroAmount</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>


<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;NotAllowedDenom&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">NotAllowedDenom</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">denom</span>: <span class="nb">String</span>
    <span class="p">},</span><span class="w"></span>


<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;NotAllowedMultipleDenoms&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">NotAllowedMultipleDenoms</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;TokenAddressMustBeWhitelisted&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">TokenAddressMustBeWhitelisted</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;ReceivedFundsMismatchWithMintAmount&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="n">ReceivedFundsMismatchWithMintAmount</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">received_amount</span>: <span class="nc">Uint128</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">expected_amount</span>: <span class="nc">Uint128</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>c. Close and save <code class="docutils literal notranslate"><span class="pre">error.rs</span></code>.</p>
<p>d. Open <code class="docutils literal notranslate"><span class="pre">msg.rs</span></code> and add the following:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="n">Uint128</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">schemars</span>::<span class="n">JsonSchema</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">InstantiateMsg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Denomination of the stable asset</span>
<span class="cm">    https://docs.terra.money/docs/develop/module-specifications/spec-market.html#market */</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">stable_denom</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Id of the contract uploaded for the first time to the chain</span>
<span class="cm">    https://docs.terra.money/docs/develop/module-specifications/spec-wasm.html#code-id */</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_contract_code_id</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Handle the deposits of native tokens into the smart contract to mint</span>
<span class="cm">    the new pegged token 1:1 with UST or to increase circulation supply. */</span><span class="w"></span>
<span class="w">    </span><span class="n">Deposit</span><span class="p">(</span><span class="n">DepositType</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Handle burn of pegged tokens 1:1 with UST which are added to</span>
<span class="cm">    MINTED_TOKENS list and return the UST stored into the contract. */</span><span class="w"></span>
<span class="w">    </span><span class="n">Burn</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">amount</span>: <span class="nc">Uint128</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">token_address</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">DepositType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Instantiate a CW20_base token */</span><span class="w"></span>
<span class="w">    </span><span class="n">Instantiate</span><span class="p">(</span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">InstantiateMsg</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Create new tokens based on token_address, amount of UST send to</span>
<span class="cm">    this contract and recipient address */</span><span class="w"></span>
<span class="w">    </span><span class="n">Mint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">token_address</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">recipient</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">QueryMsg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Returns the list of token addresses that were created with this contract */</span><span class="w"></span>
<span class="w">    </span><span class="n">GetMintedTokens</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MintedTokens</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">minted_tokens</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MigrateMsg</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div>
</div>
<p>e. Close and save <code class="docutils literal notranslate"><span class="pre">msg.rs</span></code>.</p>
<p>f. Open <code class="docutils literal notranslate"><span class="pre">state.rs</span></code> and add the following:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">schemars</span>::<span class="n">JsonSchema</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw_storage_plus</span>::<span class="n">Item</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Denomination of the stable asset</span>
<span class="cm">    https://docs.terra.money/docs/develop/module-specifications/spec-market.html#market */</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">stable_denom</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Id of the contract uploaded to the chain used to instantiate</span>
<span class="cm">    the different tokens</span>
<span class="cm">    https://docs.terra.money/docs/develop/module-specifications/spec-wasm.html#code-id */</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_contract_code_id</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">CONFIG</span>: <span class="nc">Item</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Item</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">);</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">MINTED_TOKENS</span>: <span class="nc">Item</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Item</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;minted_tokens&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>g. Close and save <code class="docutils literal notranslate"><span class="pre">state.rs</span></code>.</p>
<p>h. Open <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code> and add the following:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">contract</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">msg</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">state</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">error</span><span class="p">;</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">test</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">error</span>::<span class="n">ContractError</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>f. Open <code class="docutils literal notranslate"><span class="pre">contract.rs</span></code> and add the following:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">error</span>::<span class="n">ContractError</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">msg</span>::<span class="p">{</span><span class="n">DepositType</span><span class="p">,</span><span class="w"> </span><span class="n">ExecuteMsg</span><span class="p">,</span><span class="w"> </span><span class="n">InstantiateMsg</span><span class="p">,</span><span class="w"> </span><span class="n">MigrateMsg</span><span class="p">,</span><span class="w"> </span><span class="n">MintedTokens</span><span class="p">,</span><span class="w"> </span><span class="n">QueryMsg</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">vec</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">state</span>::<span class="p">{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">,</span><span class="w"> </span><span class="n">MINTED_TOKENS</span><span class="p">};</span><span class="w"></span>

<span class="cp">#[cfg(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">))]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="n">entry_point</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">coins</span><span class="p">,</span><span class="w"> </span><span class="n">to_binary</span><span class="p">,</span><span class="w"> </span><span class="n">BankMsg</span><span class="p">,</span><span class="w"> </span><span class="n">Binary</span><span class="p">,</span><span class="w"> </span><span class="n">Coin</span><span class="p">,</span><span class="w"> </span><span class="n">CosmosMsg</span><span class="p">,</span><span class="w"> </span><span class="n">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">Env</span><span class="p">,</span><span class="w"> </span><span class="n">MessageInfo</span><span class="p">,</span><span class="w"> </span><span class="n">Reply</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="p">,</span><span class="w"> </span><span class="n">StdResult</span><span class="p">,</span><span class="w"> </span><span class="n">SubMsg</span><span class="p">,</span><span class="w"> </span><span class="n">Uint128</span><span class="p">,</span><span class="w"> </span><span class="n">WasmMsg</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cw2</span>::<span class="n">set_contract_version</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* Define contract name and version */</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">CONTRACT_NAME</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;crates.io:token-factory&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">CONTRACT_VERSION</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="fm">env!</span><span class="p">(</span><span class="s">&quot;CARGO_PKG_VERSION&quot;</span><span class="p">);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">INSTANTIATE_REPLY_ID</span>: <span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">instantiate</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">msg</span>: <span class="nc">InstantiateMsg</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Define the initial configuration for this contract that way you can</span>
<span class="cm">    limit the type of coin you want to accept each time a token-factory is</span>
<span class="cm">    created and also which kind of token would you like to mint based on</span>
<span class="cm">    the code id of the contract deployed */</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">stable_denom</span>: <span class="nc">msg</span><span class="p">.</span><span class="n">stable_denom</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">        </span><span class="n">token_contract_code_id</span>: <span class="nc">msg</span><span class="p">.</span><span class="n">token_contract_code_id</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">set_contract_version</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">CONTRACT_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">CONTRACT_VERSION</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">CONFIG</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">MINTED_TOKENS</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">())</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;instantiate&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;token_contract_code_id&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">msg</span><span class="p">.</span><span class="n">token_contract_code_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">msg</span>: <span class="nc">ExecuteMsg</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Method executed each time someone send funds to the contract to mint</span>
<span class="cm">        a new token or to increase already existent tokens circulating supply */</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">Deposit</span><span class="p">(</span><span class="n">deposit_type</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">match_deposit</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">deposit_type</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Method used to burn an existent token created thru this contract</span>
<span class="cm">        and send the UST back to the address that burn these tokens.*/</span><span class="w"></span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">Burn</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">token_address</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_burn_from</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">token_address</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">match_deposit</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">deposit_type</span>: <span class="nc">DepositType</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">deposit_type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* When the InstantiateMsg struct is send the factory will</span>
<span class="cm">        execute this code and a new token with the defined properties</span>
<span class="cm">        will be minted */</span><span class="w"></span>
<span class="w">        </span><span class="n">DepositType</span>::<span class="n">Instantiate</span><span class="p">(</span><span class="n">token_data</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">execute_instantiate_token</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">token_data</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* If a token_address and recipient is received along with a</span>
<span class="cm">        deposit this method will increase the supply of an already</span>
<span class="cm">        existent token by the defined units of UST received */</span><span class="w"></span>
<span class="w">        </span><span class="n">DepositType</span>::<span class="n">Mint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">token_address</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">recipient</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">execute_mint</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">token_address</span><span class="p">,</span><span class="w"> </span><span class="n">recipient</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_instantiate_token</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">mut</span><span class="w"> </span><span class="n">token_data</span>: <span class="nc">cw20_base</span>::<span class="n">msg</span>::<span class="n">InstantiateMsg</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">received_funds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_received_funds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">expected_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uint128</span>::<span class="n">zero</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Add all initial token supply */</span><span class="w"></span>
<span class="w">    </span><span class="n">token_data</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">initial_balances</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">expected_amount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">amount</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Check if received_funds is different than</span>
<span class="cm">    initial token supply and throw an error */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">expected_amount</span><span class="p">.</span><span class="n">ne</span><span class="p">(</span><span class="o">&amp;</span><span class="n">received_funds</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">ReceivedFundsMismatchWithMintAmount</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">received_amount</span>: <span class="nc">received_funds</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">expected_amount</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* If a minter exists replace the minter address with</span>
<span class="cm">    the token-factory address that way the minting is only</span>
<span class="cm">    allowed thru this smart contract. */</span><span class="w"></span>
<span class="w">    </span><span class="n">token_data</span><span class="p">.</span><span class="n">mint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">token_data</span><span class="p">.</span><span class="n">mint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="n">minter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">contract</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w"></span>

<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Create a WasmMsg to mint new CW20-base token.</span>
<span class="cm">    https://github.com/CosmWasm/cw-plus/tree/0.9.x/contracts/cw20-base */</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instantiate_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasmMsg</span>::<span class="n">Instantiate</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">admin</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">contract</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span><span class="w"></span>

<span class="w">        </span><span class="n">code_id</span>: <span class="nc">config</span><span class="p">.</span><span class="n">token_contract_code_id</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">msg</span>: <span class="nc">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_data</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">funds</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w"></span>

<span class="w">        </span><span class="n">label</span>: <span class="nc">token_data</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Define the SubMessage on CosmWasm API to allow a callback on reply</span>
<span class="cm">    entry point. This call will be executed with INSTANTIATE_REPLY_ID if</span>
<span class="cm">    the call succeed after being executed by the method add_submessage(response)</span>
<span class="cm">    from Response implementation.</span>
<span class="cm">    More Info: https://docs.cosmwasm.com/docs/1.0/smart-contracts/message/submessage */</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sub_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubMsg</span>::<span class="n">reply_on_success</span><span class="p">(</span><span class="n">instantiate_message</span><span class="p">,</span><span class="w"> </span><span class="n">INSTANTIATE_REPLY_ID</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Respond with the method name and SubMsg.</span>
<span class="cm">    SubMsg will be executed to callback on reply</span>
<span class="cm">    method with INSTANTIATE_REPLY_ID as identifier</span>
<span class="cm">    to complete further operations */</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;instantiate_token&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_submessage</span><span class="p">(</span><span class="n">sub_msg</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_received_funds</span><span class="p">(</span><span class="n">deps</span>: <span class="kp">&amp;</span><span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">info</span>: <span class="kp">&amp;</span><span class="nc">MessageInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Coin</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">funds</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">NotReceivedFunds</span><span class="w"> </span><span class="p">{}),</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">received</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cm">/* Amount of tokens received cannot be zero */</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">received</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="n">is_zero</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">NotAllowZeroAmount</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="cm">/* Allow to receive only token denomination defined</span>
<span class="cm">            on contract instantiation &quot;config.stable_denom&quot; */</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">received</span><span class="p">.</span><span class="n">denom</span><span class="p">.</span><span class="n">ne</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">.</span><span class="n">stable_denom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">NotAllowedDenom</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">denom</span>: <span class="nc">received</span><span class="p">.</span><span class="n">denom</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="cm">/* Only one token can be received */</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">funds</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">NotAllowedMultipleDenoms</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_mint</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_address</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">recipient</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">received_funds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_received_funds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">token_addr_from_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MINTED_TOKENS</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">token_address</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Check if the token to be minted exists in the list, otherwise</span>
<span class="cm">    throw an error because minting must not be allowed for a token</span>
<span class="cm">    that was not created with this factory */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">token_addr_from_list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">TokenAddressMustBeWhitelisted</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Create an execute message to mint new units of an existent token */</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">execute_mint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasmMsg</span>::<span class="n">Execute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract_addr</span>: <span class="nc">token_address</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"></span>

<span class="w">        </span><span class="n">msg</span>: <span class="nc">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">ExecuteMsg</span>::<span class="n">Mint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span>: <span class="nc">received_funds</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span><span class="w"></span>

<span class="w">            </span><span class="n">recipient</span>: <span class="nc">recipient</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="o">?</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="n">funds</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* This type of SubMessage will never reply as no further operation is needed,</span>
<span class="cm">    but for sure the mint call to instantiated cw20_base contract needs to be done.</span>
<span class="cm">    More Info: https://docs.cosmwasm.com/docs/1.0/smart-contracts/message/submessage */</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">mint_sub_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubMsg</span>::<span class="n">new</span><span class="p">(</span><span class="n">execute_mint</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mint&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_submessage</span><span class="p">(</span><span class="n">mint_sub_msg</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_burn_from</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">amount</span>: <span class="nc">Uint128</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">token_address</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONFIG</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">token_addr_from_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MINTED_TOKENS</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">token_address</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Check if the token to be burned exists in the list, otherwise</span>
<span class="cm">    throw an error because minting must not be allowed for a token</span>
<span class="cm">    that was not created thru the factory */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">token_addr_from_list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">TokenAddressMustBeWhitelisted</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Amount of tokens to be burned must not be zero */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">amount</span><span class="p">.</span><span class="n">is_zero</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">NotAllowZeroAmount</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Create a SubMessage to decrease the circulating supply of existent</span>
<span class="cm">    CW20 Tokens from the token_address.</span>
<span class="cm">    https://github.com/CosmWasm/cosmwasm/blob/main/SEMANTICS.md#submessages */</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sub_msg_burn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubMsg</span>::<span class="n">new</span><span class="p">(</span><span class="n">WasmMsg</span>::<span class="n">Execute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract_addr</span>: <span class="nc">token_address</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span>: <span class="nc">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">ExecuteMsg</span>::<span class="n">BurnFrom</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">owner</span>: <span class="nc">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="o">?</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">funds</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Create a SubMessage to transfer fund from this smart contract to</span>
<span class="cm">    the address that burns the CW20 Tokens*/</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sub_msg_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubMsg</span>::<span class="n">new</span><span class="p">(</span><span class="n">CosmosMsg</span>::<span class="n">Bank</span><span class="p">(</span><span class="n">BankMsg</span>::<span class="nb">Send</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">to_address</span>: <span class="nc">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">        </span><span class="n">amount</span>: <span class="nc">coins</span><span class="p">(</span><span class="n">amount</span><span class="p">.</span><span class="kt">u128</span><span class="p">(),</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">stable_denom</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}));</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;burn&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_submessages</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">sub_msg_burn</span><span class="p">,</span><span class="w"> </span><span class="n">sub_msg_send</span><span class="p">]))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* In order to handle any callback from previous SubMessages &quot;reply&quot;</span>
<span class="cm">function must be implemented and iterate over &quot;msg.id&quot; to allow</span>
<span class="cm">the completion of the callback.*/</span><span class="w"></span>
<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">reply</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">Reply</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">INSTANTIATE_REPLY_ID</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">handle_instantiate_reply</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">),</span><span class="w"></span>

<span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Unknown reply id: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">))),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">handle_instantiate_reply</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">Reply</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">into_result</span><span class="p">().</span><span class="n">map_err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Find the event type instantiate_contract which contains the contract_address*/</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">events</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">event</span><span class="o">|</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="n">ty</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;instantiate_contract&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;cannot find `instantiate_contract` event&quot;</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Find the contract_address from instantiate_contract event*/</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">contract_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">event</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">attributes</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">attr</span><span class="o">|</span><span class="w"> </span><span class="n">attr</span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;contract_address&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;cannot find `contract_address` attribute&quot;</span><span class="p">))</span><span class="o">?</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">value</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Update the state of the contract adding the new generated MINTED_TOKEN */</span><span class="w"></span>
<span class="w">    </span><span class="n">MINTED_TOKENS</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">tokens</span><span class="o">|</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">tokens</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">contract_address</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;handle_instantiate_reply&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;contract_address&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">contract_address</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">QueryMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Return the list of all tokens that were minted thru this contract */</span><span class="w"></span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetMintedTokens</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_minted_tokens</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">?</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">query_minted_tokens</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">MintedTokens</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">MintedTokens</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">minted_tokens</span>: <span class="nc">MINTED_TOKENS</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span><span class="o">?</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* In case you want to upgrade this contract you can find information about</span>
<span class="cm">how to migrate the contract in the following link:</span>
<span class="cm">https://docs.terra.money/docs/develop/dapp/quick-start/contract-migration.html*/</span><span class="w"></span>
<span class="cp">#[cfg_attr(not(feature = </span><span class="s">&quot;library&quot;</span><span class="cp">), entry_point)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">migrate</span><span class="p">(</span><span class="n">_deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">_msg</span>: <span class="nc">MigrateMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">default</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>i. Close and save <code class="docutils literal notranslate"><span class="pre">lib.rs</span></code>.</p>
<p>j. Open <code class="docutils literal notranslate"><span class="pre">test.rs</span></code> and add the following:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[cfg(test)]</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">contract</span>::<span class="p">{</span><span class="n">execute</span><span class="p">,</span><span class="w"> </span><span class="n">instantiate</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">reply</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="n">msg</span>::<span class="p">{</span><span class="n">DepositType</span><span class="p">,</span><span class="w"> </span><span class="n">ExecuteMsg</span><span class="p">,</span><span class="w"> </span><span class="n">InstantiateMsg</span><span class="p">,</span><span class="w"> </span><span class="n">MintedTokens</span><span class="p">,</span><span class="w"> </span><span class="n">QueryMsg</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">from_binary</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">testing</span>::<span class="p">{</span><span class="n">mock_dependencies</span><span class="p">,</span><span class="w"> </span><span class="n">mock_env</span><span class="p">,</span><span class="w"> </span><span class="n">mock_info</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="n">to_binary</span><span class="p">,</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="n">Coin</span><span class="p">,</span><span class="w"> </span><span class="n">CosmosMsg</span><span class="p">,</span><span class="w"> </span><span class="n">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Reply</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">SubMsg</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">SubMsgExecutionResponse</span><span class="p">,</span><span class="w"> </span><span class="n">Uint128</span><span class="p">,</span><span class="w"> </span><span class="n">WasmMsg</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">cw20</span>::<span class="p">{</span><span class="n">Cw20Coin</span><span class="p">,</span><span class="w"> </span><span class="n">MinterResponse</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_instantiate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_dependencies</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">attributes</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="n">Attribute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">key</span>: <span class="s">&quot;method&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                    </span><span class="n">value</span>: <span class="s">&quot;instantiate&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">},</span><span class="w"></span>
<span class="w">                </span><span class="n">Attribute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">key</span>: <span class="s">&quot;token_contract_code_id&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                    </span><span class="n">value</span>: <span class="s">&quot;1&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="n">attrs</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">test_mint_token</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_dependencies</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="n">do_instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_mint_new_token</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res_attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">attributes</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">res_attr</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="s">&quot;instantiate_token&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res_attr</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">messages</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">res_message</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">success_reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubMsg</span>::<span class="n">reply_on_success</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CosmosMsg</span>::<span class="n">Wasm</span><span class="p">(</span><span class="n">WasmMsg</span>::<span class="n">Instantiate</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">admin</span>: <span class="nb">Some</span><span class="p">(</span><span class="s">&quot;cosmos2contract&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span><span class="w"></span>

<span class="w">                </span><span class="n">code_id</span>: <span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">funds</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w"></span>

<span class="w">                </span><span class="n">msg</span>: <span class="nc">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">InstantiateMsg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">name</span>: <span class="s">&quot;Bit Money&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                    </span><span class="n">symbol</span>: <span class="s">&quot;BTM&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                    </span><span class="n">decimals</span>: <span class="mi">2</span><span class="p">,</span><span class="w"></span>

<span class="w">                    </span><span class="n">mint</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">MinterResponse</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">minter</span>: <span class="s">&quot;cosmos2contract&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                        </span><span class="n">cap</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1234</span><span class="p">)),</span><span class="w"></span>
<span class="w">                    </span><span class="p">}),</span><span class="w"></span>

<span class="w">                    </span><span class="n">initial_balances</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">Cw20Coin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">123</span><span class="p">),</span><span class="w"></span>

<span class="w">                        </span><span class="n">address</span>: <span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="p">}],</span><span class="w"></span>

<span class="w">                    </span><span class="n">marketing</span>: <span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">})</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"></span>

<span class="w">                </span><span class="n">label</span>: <span class="s">&quot;Bit Money&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">}),</span><span class="w"></span>
<span class="w">            </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">success_reply</span><span class="p">,</span><span class="w"> </span><span class="n">res_message</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">test_reply_instantiate_event</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_dependencies</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_env</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_minted_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QueryMsg</span>::<span class="n">GetMintedTokens</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="n">do_instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">do_mint_new_token</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">do_instantiate_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_reply_instantiate_event</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">query_minted_tokens</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_res</span>: <span class="nc">MintedTokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_res</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;handle_instantiate_reply&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;contract_address&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="n">do_instantiate_res</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">MintedTokens</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">minted_tokens</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()]</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">query_res</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">test_mint_existent_token</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_dependencies</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_env</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_info</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Coin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">denom</span>: <span class="s">&quot;uusd&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">}],</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExecuteMsg</span>::<span class="n">Deposit</span><span class="p">(</span><span class="n">DepositType</span>::<span class="n">Mint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">token_address</span>: <span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">            </span><span class="n">recipient</span>: <span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="n">do_instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">do_mint_new_token</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">do_reply_instantiate_event</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">execute_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">(),</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mint&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">add_messages</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">CosmosMsg</span>::<span class="n">Wasm</span><span class="p">(</span><span class="n">WasmMsg</span>::<span class="n">Execute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">contract_addr</span>: <span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                    </span><span class="n">msg</span>: <span class="nc">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">ExecuteMsg</span>::<span class="n">Mint</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"></span>

<span class="w">                        </span><span class="n">recipient</span>: <span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w"></span>
<span class="w">                    </span><span class="p">})</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"></span>

<span class="w">                    </span><span class="n">funds</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w"></span>
<span class="w">                </span><span class="p">})]),</span><span class="w"></span>
<span class="w">            </span><span class="n">execute_res</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">test_burn_tokens</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_dependencies</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_env</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_info</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">exec_burn_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExecuteMsg</span>::<span class="n">Burn</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">123</span><span class="p">),</span><span class="w"></span>

<span class="w">            </span><span class="n">token_address</span>: <span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="n">do_instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">do_reply_instantiate_event</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">do_mint_new_token</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">as_mut</span><span class="p">(),</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">exec_burn_tokens</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res_attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">attributes</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">res_attr</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="s">&quot;burn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res_attr</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">messages</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">res_message</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">message_reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SubMsg</span>::<span class="n">new</span><span class="p">(</span><span class="n">CosmosMsg</span>::<span class="n">Wasm</span><span class="p">(</span><span class="n">WasmMsg</span>::<span class="n">Execute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">contract_addr</span>: <span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">            </span><span class="n">msg</span>: <span class="nc">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">ExecuteMsg</span>::<span class="n">BurnFrom</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">owner</span>: <span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">123</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">})</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"></span>

<span class="w">            </span><span class="n">funds</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[],</span><span class="w"></span>
<span class="w">        </span><span class="p">}));</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">message_reply</span><span class="p">],</span><span class="w"> </span><span class="n">res_message</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>

<span class="cm">    * HELPER METHODS TO DO NOT REPEAT CODE MANY TIMES</span>

<span class="cm">    */</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">do_instantiate</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instantiate_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InstantiateMsg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">stable_denom</span>: <span class="s">&quot;uusd&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">token_contract_code_id</span>: <span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_info</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_env</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">instantiate</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">instantiate_msg</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">do_mint_new_token</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_env</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_info</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;i_am_the_sender&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="fm">vec!</span><span class="p">[</span><span class="n">Coin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">denom</span>: <span class="s">&quot;uusd&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">123</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">}],</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">token_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cw20_base</span>::<span class="n">msg</span>::<span class="n">InstantiateMsg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">name</span>: <span class="s">&quot;Bit Money&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">symbol</span>: <span class="s">&quot;BTM&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">decimals</span>: <span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">mint</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">MinterResponse</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">minter</span>: <span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>

<span class="w">                </span><span class="n">cap</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1234</span><span class="p">)),</span><span class="w"></span>
<span class="w">            </span><span class="p">}),</span><span class="w"></span>
<span class="w">            </span><span class="n">initial_balances</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">Cw20Coin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">amount</span>: <span class="nc">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">123</span><span class="p">),</span><span class="w"></span>

<span class="w">                </span><span class="n">address</span>: <span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">}],</span><span class="w"></span>
<span class="w">            </span><span class="n">marketing</span>: <span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExecuteMsg</span>::<span class="n">Deposit</span><span class="p">(</span><span class="n">DepositType</span>::<span class="n">Instantiate</span><span class="p">(</span><span class="n">token_msg</span><span class="p">.</span><span class="n">clone</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="n">execute</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">msg</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Confirm reply event form instantiate method. That way</span>
<span class="cm">    the minted_tokens addresses can be whitelisted in factory.*/</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_reply_instantiate_event</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mock_env</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;instantiate_contract&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;token_factory_addr&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;i_am_the_sender&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;code_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;contract_address&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bit_money_contract_address&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">reply</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">deps</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">env</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">Reply</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">id</span>: <span class="mi">1</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">result</span>: <span class="nc">cosmwasm_std</span>::<span class="n">ContractResult</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">SubMsgExecutionResponse</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">events</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">event</span><span class="p">],</span><span class="w"></span>

<span class="w">                    </span><span class="n">data</span>: <span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">}),</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>h. Navigate to <code class="docutils literal notranslate"><span class="pre">token-factory/contracts/token-factory/examples</span></code>.</p>
<p>i. Open <code class="docutils literal notranslate"><span class="pre">schema.rs</span></code>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">current_dir</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">create_dir_all</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_schema</span>::<span class="p">{</span><span class="n">export_schema</span><span class="p">,</span><span class="w"> </span><span class="n">remove_schemas</span><span class="p">,</span><span class="w"> </span><span class="n">schema_for</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">token_factory</span>::<span class="n">msg</span>::<span class="p">{</span><span class="n">ExecuteMsg</span><span class="p">,</span><span class="w"> </span><span class="n">QueryMsg</span><span class="p">};</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">out_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_dir</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">out_dir</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="s">&quot;schema&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">create_dir_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">remove_schemas</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">export_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema_for</span><span class="o">!</span><span class="p">(</span><span class="n">token_factory</span>::<span class="n">msg</span>::<span class="n">InstantiateMsg</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">export_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema_for</span><span class="o">!</span><span class="p">(</span><span class="n">ExecuteMsg</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">export_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema_for</span><span class="o">!</span><span class="p">(</span><span class="n">QueryMsg</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_dir</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>3. Generate and test the schema<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<p>Now you have modified the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> contract, generate the schema and run the tests to validate that the code works as expected:</p>
<p>a. Navigate to <code class="docutils literal notranslate"><span class="pre">/tokens-factory/contracts/token-factory</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /tokens-factory/contracts/token-factory
</pre></div>
</div>
<p>b. Generate the schema:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> cargo schema
</pre></div>
</div>
<p>You should see output similar to:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Finished dev <span class="o">[</span>unoptimized + debuginfo<span class="o">]</span> target<span class="o">(</span>s<span class="o">)</span> <span class="k">in</span> <span class="m">0</span>.02s
Running <span class="sb">`</span>target/debug/examples/schema<span class="sb">`</span>
Removing <span class="s2">&quot;~/Documents/github/tokens-factory/contracts/token-factory/schema/execute_msg.json&quot;</span> …
Removing <span class="s2">&quot;~/Documents/github/tokens-factory/contracts/token-factory/schema/instantiate_msg.json&quot;</span> …
Removing <span class="s2">&quot;~/Documents/github/tokens-factory/contracts/token-factory/schema/query_msg.json&quot;</span> …
Created ~/Documents/github/tokens-factory/contracts/token-factory/schema/instantiate_msg.json
Created ~/Documents/github/tokens-factory/contracts/token-factory/schema/execute_msg.json
Created ~/Documents/github/tokens-factory/contracts/token-factory/schema/query_msg.json
</pre></div>
</div>
<p>c. Run the tests:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cargo <span class="nb">test</span>
</pre></div>
</div>
<p>You will see output similar to the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Finished <span class="nb">test</span> <span class="o">[</span>unoptimized + debuginfo<span class="o">]</span> target<span class="o">(</span>s<span class="o">)</span> <span class="k">in</span> <span class="m">0</span>.02s
Running unittests <span class="o">(</span>target/debug/deps/token_factory-03f77bf897cd72b7<span class="o">)</span>

running <span class="m">5</span> tests
<span class="nb">test</span> test::tests::test_instantiate ... ok
<span class="nb">test</span> test::tests::test_burn_tokens ... ok
<span class="nb">test</span> test::tests::test_mint_token ... ok
<span class="nb">test</span> test::tests::test_mint_existent_token ... ok
<span class="nb">test</span> test::tests::test_reply_instantiate_event ... ok
<span class="nb">test</span> result: ok. <span class="m">5</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">0</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out<span class="p">;</span> finished <span class="k">in</span> <span class="m">0</span>.00s
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>4. Modify <code class="docutils literal notranslate"><span class="pre">terrain.config.json</span></code><a class="headerlink" href="#id3" title="Permalink to this headline"></a></h2>
<p>a. Open <code class="docutils literal notranslate"><span class="pre">terrain.config.json</span></code>.</p>
<p>b. Modify the property <code class="docutils literal notranslate"><span class="pre">InstantiateMsg</span></code>, using your <code class="docutils literal notranslate"><span class="pre">&lt;token_contract_code_id&gt;</span></code>. <strong>The <code class="docutils literal notranslate"><span class="pre">&lt;token_contract_code_id&gt;</span></code> should not be surrounded by quotes</strong>:</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To determine which <code class="docutils literal notranslate"><span class="pre">&lt;token_contract_code_id&gt;</span></code>, check the file <code class="docutils literal notranslate"><span class="pre">refs.terrain.json</span></code> from the workspace’s root under the <code class="docutils literal notranslate"><span class="pre">cw20-token-factory</span></code> object.</p>
</div>
<div class="highlight-Json notranslate"><div class="highlight"><pre><span></span>{
  &quot;_global&quot;: {
    &quot;_base&quot;: {
      &quot;instantiation&quot;: {
        &quot;instantiateMsg&quot;: {
          &quot;stable_denom&quot;: &quot;uusd&quot;,
          &quot;token_contract_code_id&quot;: &lt;token_contract_id&gt;
        }
      }
    }
  }, // ...
}
</pre></div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="deploy-the-smart-contract-to-localterra">
<h1>7. Deploy the smart contract to LocalTerra<a class="headerlink" href="#deploy-the-smart-contract-to-localterra" title="Permalink to this headline"></a></h1>
<p>Now that you’ve created, modified and tested each smart contract, deploy the <code class="docutils literal notranslate"><span class="pre">token-factory</span></code> to your LocalTerra instance using Terrain:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>terrain deploy token-factory --signer <span class="nb">test</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If your code is not working as expected, you can <a class="reference external" href="https://github.com/emidev98/token-factory/commit/181192559b9d1b6356dd15812e75bddb5f270162">clone the repo with all changes done until now</a>.</p>
</div>
</div>


           </div>
          </div>
          <footer class="footer">
  <p>
    

    <div class="extra_footer container">
      <div class="row">

        <div class="col">

          <div class="logos">
            <a href="https://discord.gg/terra-rebels" rel="noopener" target="_blank"><img src="/discord.svg" alt="link to Terra Rebels discord room"></a>&nbsp;
            <a href="https://medium.com/terra-money" rel="noopener" target="_blank"><img src="/medium.svg" alt="link to Terra medium"></a>&nbsp;
            <a href="https://twitter.com/terrarebels" rel="noopener" target="_blank"><img src="/twitter.svg" alt="link to Terra Rebels twitter"></a>&nbsp;
<!--             <a href="https://www.youtube.com/channel/UCoV1RXZ9ZBGcuu_PMTTlM0g" rel="noopener" target="_blank"><img src="/icon_youtube.png" alt="link to Terra youtube"></a>&nbsp; -->
            <a href="https://t.me/OfficialTerraRebels" rel="noopener" target="_blank"><img src="/icon_telegram.png" alt="link to Terra Rebels telegram room"></a>
            <br/><br/>
          </div>

        </div>

        <div class="col-md-auto">

          <a href="https://www.terrarebels.net/" >terrarebels.net</a> <br/>
          <a href="mailto:contact@terrarebels.net" >Contact</a> <br/>
          <br/>

        </div>

        <div class="col-md-auto">

          <a href="https://assets.website-files.com/611153e7af981472d8da199c/618b02d13e938ae1f8ad1e45_Terra_White_paper.pdf" >Whitepaper</a> <br/>
          <a href="https://certik.org/projects/terra" >Security Audit</a> <br/>
          <a href="https://agora.terrarebels.net/" >Agora forum</a> <br/>
          <br/>

        </div>

        <div class="col">
          <a href="https://finder.terra.money/" >Terra Finder</a> <br/>
          <a href="https://station.terrarebels.net/" >Rebel Station</a> <br/>
          <br/>

        </div>

      </div>
    </div>


  </p>

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>